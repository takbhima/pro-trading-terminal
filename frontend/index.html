<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pro Trading Terminal</title>
<script src="https://s3.tradingview.com/tv.js"></script>

<style>
body {
    margin:0;
    background:#0b1220;
    color:white;
    font-family:Arial;
}
.grid {
    display:grid;
    grid-template-columns:3fr 1fr;
    grid-template-rows:70vh 30vh;
    gap:5px;
    height:100vh;
}
.panel {
    background:#111827;
    border-radius:6px;
    padding:5px;
    overflow:auto;
}
#chart { grid-column:1; grid-row:1 / span 2; }
#optionChain { grid-column:2; grid-row:1; }
#strategy { grid-column:2; grid-row:2; }
</style>
</head>

<body>

<div class="grid">
    <div id="chart" class="panel"></div>
    <div id="optionChain" class="panel"></div>
    <div id="strategy" class="panel">
        <h3>Live Tick</h3>
        <div id="livePrice">Connecting...</div>
    </div>
</div>

<script>
/* -------- TradingView Chart -------- */
new TradingView.widget({
    container_id: "chart",
    width: "100%",
    height: "100%",
    symbol: "BINANCE:BTCUSDT",
    interval: "5",
    timezone: "Asia/Kolkata",
    theme: "dark",
    style: "1",
    locale: "en",
    toolbar_bg: "#111827",
    enable_publishing: false,
    allow_symbol_change: true,
    hide_side_toolbar: false,
    studies: [
        "RSI@tv-basicstudies",
        "MACD@tv-basicstudies",
        "Volume@tv-basicstudies"
    ]
});

/* -------- Option Chain -------- */
async function loadOptionChain() {
    try {
        const res = await fetch("/option-chain/CANBK");
        const data = await res.json();

        document.getElementById("optionChain").innerHTML =
            "<pre>" + JSON.stringify(data.records?.data?.slice(0,5), null, 2) + "</pre>";
    } catch (err) {
        document.getElementById("optionChain").innerText = "Option chain load failed";
    }
}
loadOptionChain();

/* -------- WebSocket (Render HTTPS Safe) -------- */
const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
const socket = new WebSocket(protocol + window.location.host + "/ws");

socket.onopen = function () {
    console.log("WebSocket connected");
};

socket.onmessage = function (event) {
    const data = JSON.parse(event.data);
    const priceEl = document.getElementById("livePrice");
    if (priceEl) {
        priceEl.innerText = data.price;
    }
};

socket.onerror = function (error) {
    console.log("WebSocket error:", error);
};

socket.onclose = function () {
    console.log("WebSocket closed");
};
</script>

</body>
</html>
