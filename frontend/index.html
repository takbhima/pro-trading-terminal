<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pro Trading Terminal</title>
<script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#080f1a;--panel:#0d1626;--panel2:#0a1120;--card:#111e33;
  --border:#1a2d48;--border2:#223355;
  --green:#00e676;--green2:#00b359;--red:#ff3d57;--red2:#cc2244;
  --yellow:#ffd600;--blue:#2979ff;--blue2:#1a56cc;--purple:#7c4dff;
  --cyan:#00bcd4;--orange:#ff6d00;
  --text:#dce8ff;--subtext:#6b8cae;--dim:#3a5070;
}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;height:100vh;overflow:hidden;display:flex;flex-direction:column}

/* â”€â”€ TOPBAR â”€â”€ */
#topbar{display:flex;align-items:center;gap:8px;padding:0 14px;background:var(--panel);border-bottom:1px solid var(--border);height:46px;flex-shrink:0;position:relative}
#topbar::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--blue),transparent);opacity:.4}
.logo{display:flex;align-items:center;gap:6px;font-size:13px;font-weight:800;color:var(--blue);letter-spacing:1.5px;white-space:nowrap}
.logo-dot{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(.8)}}
#sym-input{width:190px;padding:5px 10px;background:#0d1a2d;border:1px solid var(--border2);border-radius:5px;color:var(--text);font-size:12px;outline:none;transition:border-color .2s}
#sym-input:focus{border-color:var(--blue)}
#scan-btn{padding:5px 14px;background:var(--blue);color:white;border:none;border-radius:5px;cursor:pointer;font-size:12px;font-weight:700;transition:background .2s}
#scan-btn:hover{background:var(--blue2)}
#scan-btn:disabled{background:var(--dim);cursor:not-allowed}
#tf-wrap{display:flex;gap:2px}
.tf-btn{padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--subtext);cursor:pointer;font-size:11px;transition:all .15s}
.tf-btn.active,.tf-btn:hover{background:var(--border2);color:var(--text);border-color:var(--blue)}
.sep{width:1px;height:20px;background:var(--border);margin:0 4px}
.status-dot{width:7px;height:7px;border-radius:50%;background:var(--subtext);display:inline-block;flex-shrink:0}
.status-dot.live{background:var(--green);box-shadow:0 0 6px var(--green)}
#status-lbl{font-size:10px;color:var(--subtext)}

/* â”€â”€ STRATEGY BAR â”€â”€ */
#strat-bar{display:flex;align-items:center;gap:5px;padding:0 14px;background:var(--panel2);border-bottom:1px solid var(--border);height:36px;flex-shrink:0;overflow-x:auto}
#strat-bar::-webkit-scrollbar{height:2px}
#strat-bar::-webkit-scrollbar-thumb{background:var(--border2)}
.strat-lbl{font-size:9px;color:var(--subtext);white-space:nowrap;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;margin-right:4px}
.strat-btn{display:flex;align-items:center;gap:4px;padding:3px 10px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--subtext);cursor:pointer;font-size:11px;white-space:nowrap;transition:all .15s}
.strat-btn:hover{border-color:var(--blue2);color:var(--text)}
.strat-btn.active{color:#fff;border-color:transparent}
.s-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.s-badge{font-size:9px;opacity:.6}
.strat-info{font-size:10px;color:var(--subtext);margin-left:auto;white-space:nowrap}

/* â”€â”€ LAYOUT â”€â”€ */
#main{display:grid;grid-template-columns:170px 1fr 290px;flex:1;min-height:0}

/* â”€â”€ WATCHLIST â”€â”€ */
#wl-panel{background:var(--panel2);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
#wl-hdr{padding:7px 10px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
#wl-hdr span{font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--subtext)}
#wl-add{padding:2px 8px;background:var(--blue);color:white;border:none;border-radius:3px;cursor:pointer;font-size:11px;font-weight:600}
#wl-search-wrap{padding:5px 8px;border-bottom:1px solid var(--border);flex-shrink:0}
#wl-search{width:100%;padding:3px 7px;background:#0d1a2d;border:1px solid var(--border);border-radius:3px;color:var(--text);font-size:11px;outline:none}
#wl-search:focus{border-color:var(--blue)}
#wl-items{flex:1;overflow-y:auto}
.wl-item{padding:6px 10px;cursor:pointer;border-bottom:1px solid rgba(26,45,72,.5);display:flex;justify-content:space-between;align-items:center;transition:background .1s}
.wl-item:hover{background:#111e33}
.wl-item.active{background:#102040;border-left:2px solid var(--blue);padding-left:8px}
.wl-nm{font-size:11px;font-weight:600}
.wl-tk{font-size:9px;color:var(--subtext);margin-top:1px}
.wl-sig{font-size:10px;font-weight:700}
.wl-sig.BUY{color:var(--green)}
.wl-sig.SELL{color:var(--red)}
.wl-sig.NONE{color:var(--dim)}
.wl-rm{opacity:0;background:none;border:none;color:var(--subtext);cursor:pointer;font-size:12px;padding:0 2px;line-height:1}
.wl-item:hover .wl-rm{opacity:1}

/* â”€â”€ CHART AREA â”€â”€ */
#chart-wrap{display:flex;flex-direction:column;min-width:0;position:relative;background:var(--bg)}
#chart-toolbar{display:flex;align-items:center;gap:10px;padding:3px 10px;background:var(--panel);border-bottom:1px solid var(--border);flex-shrink:0;height:28px}
#ct-sym{font-size:12px;font-weight:700}
#ct-px{font-size:12px;color:var(--yellow)}
#ct-sigs{font-size:10px;color:var(--subtext);margin-left:auto}
.ema-leg{display:flex;gap:10px}
.ema-li{display:flex;align-items:center;gap:3px;font-size:10px;color:var(--subtext)}
.ema-dot{width:12px;height:2px;border-radius:1px}
#chart{flex:1;min-height:0}
#chart-load{position:absolute;inset:28px 0 0;display:none;align-items:center;justify-content:center;background:rgba(8,15,26,.88);z-index:5;flex-direction:column;gap:8px;font-size:12px;color:var(--subtext)}
.spinner{width:22px;height:22px;border:2px solid var(--border2);border-top-color:var(--blue);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ SIDEBAR â”€â”€ */
#sidebar{display:flex;flex-direction:column;overflow:hidden;border-left:1px solid var(--border)}

/* Tabs */
#sb-tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--panel2)}
.sb-tab{flex:1;padding:6px 4px;text-align:center;font-size:10px;font-weight:600;cursor:pointer;color:var(--subtext);border:none;background:transparent;border-bottom:2px solid transparent;transition:all .15s;letter-spacing:.5px}
.sb-tab.active{color:var(--blue);border-bottom-color:var(--blue);background:var(--panel)}
.sb-tab:hover{color:var(--text)}

/* Tab panels */
.sb-panel{display:none;flex-direction:column;flex:1;overflow:hidden}
.sb-panel.active{display:flex}

/* â”€â”€ SIGNAL PANEL â”€â”€ */
#sig-panel{overflow-y:auto;padding:8px}
.p-title{font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--subtext);margin-bottom:6px}

/* Hero signal */
#hero-inner{border-radius:6px;padding:10px;display:none;margin-bottom:8px}
#hero-inner.BUY{background:rgba(0,230,118,.06);border:1px solid rgba(0,230,118,.2)}
#hero-inner.SELL{background:rgba(255,61,87,.06);border:1px solid rgba(255,61,87,.2)}
.hero-type{font-size:16px;font-weight:900;letter-spacing:2px;margin-bottom:7px}
.hero-type.BUY{color:var(--green)}
.hero-type.SELL{color:var(--red)}
.hero-grid{display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-bottom:6px}
.hc{background:#0d1a2d;border-radius:3px;padding:4px 7px}
.hc .lbl{font-size:8px;color:var(--subtext);text-transform:uppercase;letter-spacing:.5px}
.hc .val{font-size:12px;font-weight:700;margin-top:1px}
/* Target time card â€” full width, highlighted */
.hc.target-card{grid-column:1/-1;background:rgba(255,214,0,.06);border:1px solid rgba(255,214,0,.2);padding:6px 8px}
.hc.target-card .lbl{color:var(--yellow)}
.hc.target-card .val{font-size:13px;color:var(--yellow)}
.hc.target-card .val-sub{font-size:10px;color:var(--subtext);margin-top:1px}
.hero-why{font-size:10px;color:var(--subtext);line-height:1.8}
.hero-why .ck{color:var(--green);font-weight:700}

/* Signal history cards */
.sig-card{border-radius:4px;padding:6px 8px;margin-bottom:4px;border-left:2px solid transparent;background:var(--card);font-size:10px}
.sig-card.BUY{border-color:var(--green)}
.sig-card.SELL{border-color:var(--red)}
.sig-row{display:flex;justify-content:space-between;margin-top:2px;color:var(--subtext)}
.sig-row .v{color:var(--text);font-weight:600}
#no-signal{text-align:center;color:var(--subtext);font-size:11px;padding:20px 8px;line-height:2}
#no-signal .icon{font-size:24px;margin-bottom:6px}

/* Risk calc */
#risk-section{padding:8px;border-top:1px solid var(--border);flex-shrink:0;background:var(--panel2)}
.r-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:6px}
.ig label{display:block;font-size:8px;color:var(--subtext);margin-bottom:2px;text-transform:uppercase;letter-spacing:.5px}
.ig input{width:100%;padding:4px 6px;background:#0d1a2d;border:1px solid var(--border);border-radius:3px;color:var(--text);font-size:11px;outline:none}
.ig input:focus{border-color:var(--blue)}
#calc-btn{width:100%;padding:6px;background:var(--blue);color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px;font-weight:700;margin-bottom:4px}
#risk-res{background:#0d1a2d;border-radius:3px;padding:6px;display:none}
.rr{display:flex;justify-content:space-between;font-size:10px;padding:2px 0;border-bottom:1px solid var(--border)}
.rr:last-child{border:none}
.rr .rv{font-weight:700;color:var(--yellow)}

/* â”€â”€ NEWS PANEL â”€â”€ */
#news-panel{overflow-y:auto;padding:8px;gap:0}
#news-refresh{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-shrink:0}
#news-refresh-btn{padding:3px 8px;background:var(--border2);border:none;border-radius:3px;color:var(--text);font-size:10px;cursor:pointer}
#news-refresh-btn:hover{background:var(--blue)}
#news-ts{font-size:9px;color:var(--subtext)}
#news-loading{text-align:center;padding:20px;color:var(--subtext);font-size:11px;display:none}
.news-card{background:var(--card);border-radius:5px;padding:9px 10px;margin-bottom:6px;border:1px solid var(--border);cursor:pointer;transition:border-color .15s;text-decoration:none;display:block}
.news-card:hover{border-color:var(--border2)}
.news-card.positive{border-left:3px solid var(--green)}
.news-card.negative{border-left:3px solid var(--red)}
.news-card.neutral{border-left:3px solid var(--dim)}
.news-top{display:flex;justify-content:space-between;align-items:flex-start;gap:6px;margin-bottom:4px}
.news-cat{display:flex;align-items:center;gap:3px;font-size:9px;padding:1px 5px;border-radius:2px;background:var(--border2);color:var(--subtext);white-space:nowrap}
.news-age{font-size:9px;color:var(--dim);white-space:nowrap}
.news-title{font-size:11px;line-height:1.4;color:var(--text)}
.news-bottom{display:flex;justify-content:space-between;align-items:center;margin-top:4px}
.news-src{font-size:9px;color:var(--subtext)}
.news-sent{font-size:9px;font-weight:700;padding:1px 5px;border-radius:2px}
.news-sent.positive{color:var(--green);background:rgba(0,230,118,.1)}
.news-sent.negative{color:var(--red);background:rgba(255,61,87,.1)}
.news-sent.neutral{color:var(--subtext);background:var(--border)}
.news-sym{font-size:8px;color:var(--blue);background:rgba(41,121,255,.1);padding:1px 4px;border-radius:2px}

/* â”€â”€ PREDICTION PANEL â”€â”€ */
#pred-panel{overflow-y:auto;padding:8px}
#pred-sym-row{display:flex;align-items:center;gap:6px;margin-bottom:8px;flex-shrink:0}
#pred-sym-lbl{font-size:11px;font-weight:700;flex:1}
#pred-refresh-btn{padding:3px 8px;background:var(--border2);border:none;border-radius:3px;color:var(--text);font-size:10px;cursor:pointer}
#pred-refresh-btn:hover{background:var(--blue)}
#pred-loading{text-align:center;padding:20px;color:var(--subtext);font-size:11px;display:none}
#pred-content{display:none}

/* Prediction meter */
.pred-header{text-align:center;padding:10px;background:var(--card);border-radius:6px;margin-bottom:8px}
.pred-dir{font-size:22px;font-weight:900;letter-spacing:2px;margin-bottom:4px}
.pred-dir.BULLISH{color:var(--green)}
.pred-dir.BEARISH{color:var(--red)}
.pred-dir.NEUTRAL{color:var(--yellow)}
.pred-conf-bar-wrap{background:var(--border);border-radius:10px;height:6px;margin:6px 0;overflow:hidden}
.pred-conf-bar{height:100%;border-radius:10px;transition:width .5s ease}
.pred-conf-lbl{font-size:10px;color:var(--subtext)}
.score-row{display:flex;gap:6px;margin-bottom:8px}
.score-box{flex:1;background:var(--card);border-radius:4px;padding:6px;text-align:center}
.score-box .s-lbl{font-size:8px;color:var(--subtext);text-transform:uppercase;letter-spacing:.5px}
.score-box .s-val{font-size:16px;font-weight:800;margin-top:2px}
.pred-targets{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;margin-bottom:8px}
.pt{background:var(--card);border-radius:4px;padding:6px;text-align:center}
.pt .pt-lbl{font-size:8px;color:var(--subtext);text-transform:uppercase}
.pt .pt-val{font-size:12px;font-weight:700;margin-top:2px}
.pred-reasons{background:var(--card);border-radius:5px;padding:8px;margin-bottom:8px}
.pr-title{font-size:9px;color:var(--subtext);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px}
.pr-item{font-size:10px;padding:2px 0;line-height:1.5}
.pr-item.bull{color:var(--green)}
.pr-item.bear{color:var(--red)}
.pr-item.neut{color:var(--subtext)}

/* â”€â”€ MODAL â”€â”€ */
#modal-ov{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;display:none;align-items:center;justify-content:center}
#modal-ov.show{display:flex}
#modal-box{background:var(--panel);border:1px solid var(--border2);border-radius:8px;padding:20px;width:320px;box-shadow:0 20px 60px rgba(0,0,0,.6)}
#modal-box h3{font-size:13px;margin-bottom:12px}
.m-inp{width:100%;padding:7px 10px;background:#0d1a2d;border:1px solid var(--border2);border-radius:4px;color:var(--text);font-size:12px;margin-bottom:7px;outline:none}
.m-inp:focus{border-color:var(--blue)}
.m-btns{display:flex;gap:8px;margin-top:6px}
.m-btns button{flex:1;padding:7px;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600}
#m-ok{background:var(--blue);color:white}
#m-cancel{background:var(--border2);color:var(--subtext)}
.m-err{color:var(--red);font-size:11px;margin-bottom:5px;display:none}

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}

#conn-banner{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);background:var(--card);padding:6px 16px;border-radius:20px;font-size:11px;color:var(--subtext);display:none;z-index:999;border:1px solid var(--border2)}

/* â”€â”€ ACTIVE TRADE PANEL â”€â”€ */
#trade-panel{display:none;border-radius:6px;padding:10px;margin-bottom:8px;position:relative}
#trade-panel.BUY {background:rgba(0,230,118,.07);border:1px solid rgba(0,230,118,.25)}
#trade-panel.SELL{background:rgba(255,61,87,.07); border:1px solid rgba(255,61,87,.25)}
.trade-badge{display:inline-flex;align-items:center;gap:5px;font-size:9px;font-weight:700;
  letter-spacing:1px;text-transform:uppercase;padding:2px 7px;border-radius:10px;
  margin-bottom:7px}
.trade-badge.BUY {color:var(--green);background:rgba(0,230,118,.12);border:1px solid rgba(0,230,118,.3)}
.trade-badge.SELL{color:var(--red);  background:rgba(255,61,87,.12); border:1px solid rgba(255,61,87,.3)}
.trade-badge::before{content:'';width:6px;height:6px;border-radius:50%;background:currentColor;
  animation:pulse 1.2s infinite}
.trade-grid{display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-bottom:6px}
.tc{background:rgba(0,0,0,.2);border-radius:3px;padding:4px 7px}
.tc .lbl{font-size:8px;color:var(--subtext);text-transform:uppercase;letter-spacing:.5px}
.tc .val{font-size:12px;font-weight:700;margin-top:1px}
#trade-pnl-row{display:flex;justify-content:space-between;align-items:center;
  padding:5px 8px;border-radius:4px;background:rgba(0,0,0,.25);margin-bottom:5px}
#trade-pnl-lbl{font-size:9px;color:var(--subtext);text-transform:uppercase;letter-spacing:.5px}
#trade-pnl-val{font-size:16px;font-weight:900;font-variant-numeric:tabular-nums}
#trade-pnl-val.profit{color:var(--green)}
#trade-pnl-val.loss  {color:var(--red)}
#trade-elapsed{font-size:9px;color:var(--subtext);text-align:right;margin-bottom:5px}
.progress-wrap{height:3px;background:var(--border);border-radius:2px;margin-bottom:6px;overflow:hidden}
.progress-bar{height:100%;border-radius:2px;transition:width .5s linear}
.progress-bar.BUY {background:var(--green)}
.progress-bar.SELL{background:var(--red)}
#trade-close-btn{width:100%;padding:5px;background:rgba(255,61,87,.12);color:var(--red);
  border:1px solid rgba(255,61,87,.3);border-radius:4px;cursor:pointer;font-size:10px;
  font-weight:700;transition:all .15s}
#trade-close-btn:hover{background:rgba(255,61,87,.25)}

/* â”€â”€ EXIT BANNER â”€â”€ */
#exit-banner{display:none;border-radius:6px;padding:10px;margin-bottom:8px}
#exit-banner.profit{background:rgba(0,230,118,.08);border:1px solid rgba(0,230,118,.3)}
#exit-banner.loss  {background:rgba(255,61,87,.08); border:1px solid rgba(255,61,87,.3)}
.exit-title{font-size:13px;font-weight:900;letter-spacing:1px;margin-bottom:6px}
.exit-title.profit{color:var(--green)}
.exit-title.loss  {color:var(--red)}
.exit-reason-badge{display:inline-block;font-size:9px;padding:2px 7px;border-radius:10px;
  font-weight:700;letter-spacing:.5px;margin-bottom:7px}
.exit-reason-badge.target{background:rgba(0,230,118,.15);color:var(--green);border:1px solid rgba(0,230,118,.3)}
.exit-reason-badge.stop  {background:rgba(255,61,87,.15); color:var(--red);  border:1px solid rgba(255,61,87,.3)}
.exit-reason-badge.time  {background:rgba(255,214,0,.12); color:var(--yellow);border:1px solid rgba(255,214,0,.25)}
.exit-reason-badge.eod   {background:rgba(107,140,174,.12);color:var(--subtext);border:1px solid var(--border2)}
.exit-reason-badge.manual{background:rgba(107,140,174,.12);color:var(--subtext);border:1px solid var(--border2)}
.exit-grid{display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-bottom:5px}
.ec{background:rgba(0,0,0,.2);border-radius:3px;padding:4px 7px}
.ec .lbl{font-size:8px;color:var(--subtext);text-transform:uppercase;letter-spacing:.5px}
.ec .val{font-size:12px;font-weight:700;margin-top:1px}
#exit-dismiss{margin-top:5px;width:100%;padding:4px;background:transparent;
  border:1px solid var(--border2);border-radius:4px;color:var(--subtext);cursor:pointer;font-size:10px}
#exit-dismiss:hover{background:var(--border)}
</style>
</head>
<body>

<!-- TOPBAR -->
<div id="topbar">
  <div class="logo"><div class="logo-dot"></div>PRO TERMINAL</div>
  <div style="display:flex;gap:5px">
    <input id="sym-input" type="text" placeholder="AAPL Â· RELIANCE.NS Â· ^NSEI Â· BTC-USD" />
    <button id="scan-btn" onclick="scanSymbol()">â–¶ Scan</button>
  </div>
  <div id="tf-wrap">
    <button class="tf-btn" onclick="setTF('5m',this)">5m</button>
    <button class="tf-btn" onclick="setTF('15m',this)">15m</button>
    <button class="tf-btn" onclick="setTF('1h',this)">1H</button>
    <button class="tf-btn active" onclick="setTF('1d',this)">1D</button>
    <button class="tf-btn" onclick="setTF('1wk',this)">1W</button>
  </div>
  <div class="sep"></div>
  <div style="display:flex;align-items:center;gap:8px;margin-left:auto">
    <div id="live-tick" style="display:none;align-items:center;gap:5px;background:#0d1a2d;border:1px solid var(--border2);border-radius:4px;padding:2px 8px">
      <span style="font-size:9px;color:var(--subtext)" id="tick-sym">â€”</span>
      <span style="font-size:12px;font-weight:700;color:var(--yellow)" id="tick-price">â€”</span>
      <span style="font-size:11px;font-weight:600" id="tick-chg">â€”</span>
    </div>
    <div style="display:flex;align-items:center;gap:4px">
      <span class="status-dot" id="dot"></span>
      <span id="status-lbl">Connectingâ€¦</span>
    </div>
    <div id="mkt-badges" style="display:flex;gap:3px"></div>
  </div>
</div>

<!-- STRATEGY BAR -->
<div id="strat-bar"><span class="strat-lbl">Strategy:</span></div>

<!-- MAIN -->
<div id="main">

  <!-- WATCHLIST -->
  <div id="wl-panel">
    <div id="wl-hdr">
      <span>ğŸ“‹ Watchlist</span>
      <button id="wl-add" onclick="openModal()">+ Add</button>
    </div>
    <div id="wl-search-wrap">
      <input id="wl-search" type="text" placeholder="Filterâ€¦" oninput="filterWL(this.value)"/>
    </div>
    <div id="wl-items"><div style="padding:20px;text-align:center;color:var(--subtext);font-size:11px">Loadingâ€¦</div></div>
  </div>

  <!-- CHART -->
  <div id="chart-wrap">
    <div id="chart-toolbar" title="All times shown in IST (Asia/Kolkata)">
      <span id="ct-sym">â€”</span>
      <span id="ct-px">â€”</span><span style="font-size:9px;color:var(--subtext);background:var(--border2);padding:1px 4px;border-radius:2px;margin-left:2px">IST</span>
      <div class="ema-leg">
        <div class="ema-li"><div class="ema-dot" style="background:#00e676"></div>EMA9</div>
        <div class="ema-li"><div class="ema-dot" style="background:#ff3d57"></div>EMA21</div>
        <div class="ema-li"><div class="ema-dot" style="background:#2979ff;height:3px"></div>EMA200</div>
      </div>
      <span id="ct-sigs"></span>
    </div>
    <div id="chart"></div>
    <div id="chart-load"><div class="spinner"></div><span>Loadingâ€¦</span></div>
  </div>

  <!-- SIDEBAR -->
  <div id="sidebar">

    <!-- Tabs -->
    <div id="sb-tabs">
      <button class="sb-tab active" onclick="switchTab('signal',this)">ğŸ“Œ Signal</button>
      <button class="sb-tab"        onclick="switchTab('news',this)">ğŸ“° News</button>
      <button class="sb-tab"        onclick="switchTab('predict',this)">ğŸ¤– Predict</button>
    </div>

    <!-- SIGNAL TAB -->
    <div class="sb-panel active" id="tab-signal">
      <div id="sig-panel">
        <div class="p-title">Latest Signal</div>
        <div id="hero-inner"></div>

        <!-- ACTIVE TRADE PANEL -->
        <div id="trade-panel">
          <div id="trade-badge" class="trade-badge"></div>
          <div id="trade-pnl-row">
            <span id="trade-pnl-lbl">Live P&amp;L</span>
            <span id="trade-pnl-val">â€”</span>
          </div>
          <div class="trade-grid">
            <div class="tc"><div class="lbl">Entry</div><div class="val" id="td-entry">â€”</div></div>
            <div class="tc"><div class="lbl">Current</div><div class="val" id="td-cur">â€”</div></div>
            <div class="tc"><div class="lbl">Target</div><div class="val" style="color:var(--green)" id="td-tp">â€”</div></div>
            <div class="tc"><div class="lbl">Stop Loss</div><div class="val" style="color:var(--red)" id="td-sl">â€”</div></div>
            <div class="tc"><div class="lbl">Strategy</div><div class="val" id="td-strat">â€”</div></div>
            <div class="tc"><div class="lbl">Confidence</div><div class="val" id="td-conf">â€”</div></div>
          </div>
          <div class="progress-wrap"><div class="progress-bar BUY" id="td-progress" style="width:0%"></div></div>
          <div id="trade-elapsed">â± Elapsed: <span id="td-elapsed">0m</span> Â· Est: <span id="td-est">â€”</span></div>
          <button id="trade-close-btn" onclick="manualCloseTrade()">âœ• Close Trade Now</button>
        </div>

        <!-- EXIT BANNER -->
        <div id="exit-banner">
          <div class="exit-title" id="exit-title">â€”</div>
          <div id="exit-reason-badge" class="exit-reason-badge"></div>
          <div class="exit-grid">
            <div class="ec"><div class="lbl">Entry</div><div class="val" id="ex-entry">â€”</div></div>
            <div class="ec"><div class="lbl">Exit Price</div><div class="val" id="ex-exit">â€”</div></div>
            <div class="ec"><div class="lbl">P&amp;L</div><div class="val" id="ex-pnl">â€”</div></div>
            <div class="ec"><div class="lbl">Duration</div><div class="val" id="ex-dur">â€”</div></div>
          </div>
          <button id="exit-dismiss" onclick="dismissExit()">â†© Dismiss â€” Ready for next signal</button>
        </div>

        <div id="no-signal"><div class="icon">ğŸ“¡</div>Select a symbol from the watchlist<br>or scan one above</div>
        <div class="p-title" style="margin-top:8px">Signal History</div>
        <div id="sig-hist"></div>
      </div>
      <div id="risk-section">
        <div class="p-title">ğŸ§® Risk Calculator</div>
        <div class="r-grid">
          <div class="ig"><label>Capital</label><input id="capital" type="number" value="100000"></div>
          <div class="ig"><label>Risk %</label><input id="riskPct" type="number" value="1" step="0.1"></div>
          <div class="ig"><label>Entry</label><input id="entry-inp" type="number" placeholder="262.50"></div>
          <div class="ig"><label>Stop Loss</label><input id="sl-inp" type="number" placeholder="258.00"></div>
        </div>
        <button id="calc-btn" onclick="calcRisk()">Calculate Position Size</button>
        <div id="risk-res"></div>
      </div>
    </div>

    <!-- NEWS TAB -->
    <div class="sb-panel" id="tab-news">
      <div id="news-panel">
        <div id="news-refresh">
          <div id="news-ts">Tap refresh to load news</div>
          <button id="news-refresh-btn" onclick="loadNews()">â†» Refresh</button>
        </div>
        <div id="news-loading">â³ Fetching breaking newsâ€¦</div>
        <div id="news-list"></div>
      </div>
    </div>

    <!-- PREDICT TAB -->
    <div class="sb-panel" id="tab-predict">
      <div id="pred-panel">
        <div id="pred-sym-row">
          <span id="pred-sym-lbl">Select a symbol first</span>
          <button id="pred-refresh-btn" onclick="loadPrediction()">â†» Refresh</button>
        </div>
        <div id="pred-loading">â³ Analysing market dataâ€¦</div>
        <div id="pred-content"></div>
      </div>
    </div>


  </div><!-- /sidebar -->
</div><!-- /main -->

<!-- ADD WATCHLIST MODAL -->
<div id="modal-ov">
  <div id="modal-box">
    <h3>â• Add to Watchlist</h3>
    <div class="m-err" id="m-err"></div>
    <input class="m-inp" id="m-sym"  type="text" placeholder="Yahoo ticker: AAPL, RELIANCE.NS, ^NSEI"/>
    <input class="m-inp" id="m-name" type="text" placeholder="Display name (e.g. Apple Inc)"/>
    <div class="m-btns">
      <button id="m-ok" onclick="confirmAdd()">Add</button>
      <button id="m-cancel" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<div id="conn-banner">âš ï¸ Reconnectingâ€¦</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let curYahoo = '^BSESN', curLabel = 'SENSEX', curTF = '1d', curStrategy = 'pro_mtf';
let watchlist = [], wlSignals = {}, wlFilter = '', sigHistory = [], strategies = [];
let newsCache = null, predCache = {};
let activeTrade = null, tradeTimer = null, lastLivePrice = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  await Promise.all([loadStrategies(), loadWatchlist()]);
  initChart();
  connectWS();
  doScan(curYahoo, curLabel, curTF);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(name, btn) {
  document.querySelectorAll('.sb-tab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.sb-panel').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
  if (name === 'news' && !newsCache) loadNews();
  if (name === 'predict') loadPrediction();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STRATEGIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadStrategies() {
  try {
    strategies = await (await fetch('/api/strategies')).json();
    renderStratBar();
  } catch(e) { console.error('Strategies:', e); }
}

function renderStratBar() {
  const bar = document.getElementById('strat-bar');
  bar.innerHTML = '<span class="strat-lbl">Strategy:</span>';
  strategies.forEach(s => {
    const b = document.createElement('button');
    b.className = 'strat-btn' + (s.key === curStrategy ? ' active' : '');
    if (s.key === curStrategy) { b.style.background = s.color + '22'; b.style.borderColor = s.color; b.style.color = s.color; }
    b.title = `${s.description}\nBest: ${s.best_for} | ~${s.signals_day} signals/day`;
    b.innerHTML = `<div class="s-dot" style="background:${s.color}"></div>${s.name}<span class="s-badge">${s.signals_day}</span>`;
    b.onclick = () => { curStrategy = s.key; renderStratBar(); if (curYahoo) doScan(curYahoo, curLabel, curTF); };
    bar.appendChild(b);
  });
  const cur = strategies.find(s => s.key === curStrategy);
  if (cur) {
    const info = document.createElement('span');
    info.className = 'strat-info';
    info.textContent = `${cur.style} Â· ${cur.best_for} Â· ~${cur.signals_day}/day`;
    bar.appendChild(info);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WATCHLIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadWatchlist() {
  try {
    watchlist = await (await fetch('/api/watchlist')).json();
    renderWL();
  } catch(e) { console.error('Watchlist:', e); }
}

function renderWL() {
  const el = document.getElementById('wl-items');
  const filtered = watchlist.filter(w => !wlFilter ||
    w.sym.toLowerCase().includes(wlFilter.toLowerCase()) ||
    (w.name||'').toLowerCase().includes(wlFilter.toLowerCase()));
  if (!filtered.length) { el.innerHTML = '<div style="padding:16px;text-align:center;color:var(--subtext);font-size:11px">No items</div>'; return; }
  el.innerHTML = filtered.map(w => {
    const sig = wlSignals[w.sym] || 'NONE';
    const sigTxt = sig==='BUY'?'â–² BUY':sig==='SELL'?'â–¼ SELL':'â€”';
    return `<div class="wl-item${w.sym===curYahoo?' active':''}" onclick="wlClick('${w.sym}','${w.name||w.sym}')">
      <div><div class="wl-nm">${w.name||w.sym}</div><div class="wl-tk">${w.sym}</div></div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:2px">
        <span class="wl-sig ${sig}">${sigTxt}</span>
        <button class="wl-rm" onclick="removeWL(event,'${w.sym}')">âœ•</button>
      </div>
    </div>`;
  }).join('');
}

function filterWL(v) { wlFilter = v; renderWL(); }
function wlClick(sym, name) { doScan(sym, name, curTF); }

async function removeWL(e, sym) {
  e.stopPropagation();
  await fetch(`/api/watchlist/${encodeURIComponent(sym)}`, {method:'DELETE'});
  watchlist = watchlist.filter(w => w.sym !== sym);
  renderWL();
}

function openModal() {
  document.getElementById('m-sym').value = '';
  document.getElementById('m-name').value = '';
  document.getElementById('m-err').style.display = 'none';
  document.getElementById('modal-ov').classList.add('show');
  setTimeout(() => document.getElementById('m-sym').focus(), 50);
}
function closeModal() { document.getElementById('modal-ov').classList.remove('show'); }

async function confirmAdd() {
  const sym  = document.getElementById('m-sym').value.trim().toUpperCase();
  const name = document.getElementById('m-name').value.trim() || sym;
  const errEl = document.getElementById('m-err');
  if (!sym) { errEl.textContent='Enter a ticker symbol'; errEl.style.display='block'; return; }
  const res  = await fetch(`/api/watchlist?sym=${encodeURIComponent(sym)}&name=${encodeURIComponent(name)}`, {method:'POST'});
  const data = await res.json();
  if (!data.ok) { errEl.textContent = data.reason || 'Already in watchlist'; errEl.style.display='block'; return; }
  watchlist = data.watchlist;
  renderWL(); closeModal();
  doScan(sym, name, curTF);
}

document.getElementById('modal-ov').addEventListener('click', e => { if (e.target===document.getElementById('modal-ov')) closeModal(); });
document.getElementById('m-sym').addEventListener('keydown',  e => { if(e.key==='Enter') document.getElementById('m-name').focus(); });
document.getElementById('m-name').addEventListener('keydown', e => { if(e.key==='Enter') confirmAdd(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let chart, candleSeries, ema9S, ema21S, ema200S;

function initChart() {
  const el = document.getElementById('chart');
  chart = LightweightCharts.createChart(el, {
    layout:{background:{color:'#080f1a'},textColor:'#6b8cae'},
    grid:{vertLines:{color:'#0d1a2d'},horzLines:{color:'#0d1a2d'}},
    crosshair:{mode:LightweightCharts.CrosshairMode.Normal},
    rightPriceScale:{borderColor:'#1a2d48'},
    timeScale:{borderColor:'#1a2d48',timeVisible:true,secondsVisible:false},

    width:el.offsetWidth, height:el.offsetHeight,
  });
  candleSeries = chart.addCandlestickSeries({upColor:'#00e676',downColor:'#ff3d57',borderUpColor:'#00e676',borderDownColor:'#ff3d57',wickUpColor:'#00e676',wickDownColor:'#ff3d57'});
  ema9S   = chart.addLineSeries({color:'#00e676',lineWidth:1,priceLineVisible:false,lastValueVisible:false});
  ema21S  = chart.addLineSeries({color:'#ff3d57',lineWidth:1,priceLineVisible:false,lastValueVisible:false});
  ema200S = chart.addLineSeries({color:'#2979ff',lineWidth:2,priceLineVisible:false,lastValueVisible:false});
  new ResizeObserver(() => chart.resize(el.offsetWidth, el.offsetHeight)).observe(el);
}

// â”€â”€ Timezone offset applied to unix timestamps so LWC shows LOCAL time â”€â”€â”€â”€â”€â”€
// Browser's getTimezoneOffset() returns minutes WEST of UTC (negative for IST)
// Multiply by -60 to get seconds EAST of UTC (positive for IST = +19800)
const TZ_OFFSET_S = new Date().getTimezoneOffset() * -60;

function applyTZ(ts) {
  // Only offset numeric (unix) timestamps â€” leave date strings alone
  return (typeof ts === 'number') ? ts + TZ_OFFSET_S : ts;
}

function applyTZtoSeries(arr) {
  return arr.map(item => ({...item, time: applyTZ(item.time)}));
}

async function loadChart(yahoo, label, tf, strategy) {
  document.getElementById('chart-load').style.display = 'flex';
  document.getElementById('ct-sym').textContent = label;
  document.getElementById('ct-sigs').textContent = '';
  try {
    const data = await (await fetch(`/api/chartdata?symbol=${encodeURIComponent(yahoo)}&interval=${tf}&strategy=${strategy}`)).json();
    if (data.error) { document.getElementById('ct-sym').textContent = `${label} â€” ${data.error}`; return; }
    if (!data.candles?.length) { document.getElementById('ct-sym').textContent = `${label} â€” No data`; return; }

    try { candleSeries.setData(applyTZtoSeries(data.candles)); } catch(e) { console.error('candles',e); }
    try { ema9S.setData(applyTZtoSeries(data.ema9)); } catch(e) {}
    try { ema21S.setData(applyTZtoSeries(data.ema21)); } catch(e) {}
    try { ema200S.setData(applyTZtoSeries(data.ema200)); } catch(e) {}

    if (data.signals?.length) {
      try {
        candleSeries.setMarkers(data.signals.filter(s=>s.time!=null).map(s => ({
          time:applyTZ(s.time), position:s.type==='BUY'?'belowBar':'aboveBar',
          color:s.type==='BUY'?'#00e676':'#ff3d57',
          shape:s.type==='BUY'?'arrowUp':'arrowDown',
          text:s.type, size:2,
        })));
      } catch(e) { console.error('markers',e); }
      const cur = strategies.find(s=>s.key===strategy);
      document.getElementById('ct-sigs').textContent = `${data.signals.length} signals Â· ${cur?.name||strategy}`;
    } else {
      try { candleSeries.setMarkers([]); } catch(e) {}
      document.getElementById('ct-sigs').textContent = 'No signals on this TF';
    }

    const last = data.candles[data.candles.length-1];
    document.getElementById('ct-px').textContent = fmt(last.close);
    if (data.latest_signal) {
      showHero({...data.latest_signal, symbol:label});
      wlSignals[yahoo] = data.latest_signal.type;
      renderWL();
    }
    if (data.active_trade) { setActiveTrade(data.active_trade); } else { clearActiveTrade(); }
    chart.timeScale().fitContent();
  } catch(e) {
    console.error('Chart error:', e);
    document.getElementById('ct-sym').textContent = `${label} â€” ${e.message}`;
  } finally {
    document.getElementById('chart-load').style.display = 'none';
  }
}

async function doScan(yahoo, label, tf) {
  curYahoo = yahoo; curLabel = label;
  document.getElementById('sym-input').value = yahoo;
  document.getElementById('pred-sym-lbl').textContent = label;
  predCache[yahoo] = null;
  renderWL();
  // Tell WebSocket which symbol we're viewing for live ticks
  function sendSubscribe() {
    if (wsConn && wsConn.readyState === WebSocket.OPEN) {
      wsConn.send(JSON.stringify({type:'subscribe', symbol: yahoo, interval: curTF}));
    }
  }
  sendSubscribe();
  setTimeout(sendSubscribe, 1000);
  // Reset tick display
  document.getElementById('tick-sym').textContent = label;
  document.getElementById('live-tick').style.display = 'flex';
  await loadChart(yahoo, label, tf, curStrategy);
  const predTab = document.getElementById('tab-predict');
  if (predTab.classList.contains('active')) loadPrediction();
}

function updateTick(d) {
  // â”€â”€ 1. Update toolbar price badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('tick-sym').textContent   = d.symbol;
  document.getElementById('tick-price').textContent = fmt(d.price);
  const chgEl = document.getElementById('tick-chg');
  const up = d.change >= 0;
  chgEl.textContent = `${up?'â–²':'â–¼'} ${Math.abs(d.change_pct).toFixed(2)}%`;
  chgEl.style.color = up ? 'var(--green)' : 'var(--red)';
  document.getElementById('ct-px').textContent = fmt(d.price);
  document.getElementById('ct-px').style.color = up ? 'var(--green)' : 'var(--yellow)';

  // â”€â”€ 2. Update the live candle on the chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (d.bar && candleSeries && d.symbol === curYahoo) {
    try {
      const bar = {
        time : applyTZ(d.bar.time),
        open : d.bar.open,
        high : d.bar.high,
        low  : d.bar.low,
        close: d.bar.close,
      };
      candleSeries.update(bar);
    } catch(e) {}
  }
  // â”€â”€ 3. Live P&L update for active trade â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (d.symbol === curYahoo) {
    lastLivePrice = d.price;
    if (d.active_trade && !activeTrade) setActiveTrade(d.active_trade);
    if (activeTrade && d.live_pnl != null) updateLivePnl(d.live_pnl, d.price);
  }
}

function renderMktBadges(openMarkets) {
  const el = document.getElementById('mkt-badges');
  const all = ['NSE','NYSE','NASDAQ','LSE'];
  el.innerHTML = all.map(m => {
    const on  = openMarkets.includes(m);
    const bg  = on ? 'rgba(0,230,118,.15)' : 'rgba(107,140,174,.08)';
    const clr = on ? 'var(--green)'        : 'var(--dim)';
    const bdr = on ? 'rgba(0,230,118,.3)'  : 'var(--border)';
    return '<span style="font-size:8px;padding:1px 5px;border-radius:2px;font-weight:700;background:'+bg+';color:'+clr+';border:1px solid '+bdr+'">'+m+'</span>';
  }).join('');
}

function scanSymbol() {
  const raw = document.getElementById('sym-input').value.trim();
  if (!raw) { alert('Enter a symbol: AAPL, RELIANCE.NS, ^NSEI, BTC-USD'); return; }
  const btn = document.getElementById('scan-btn');
  btn.disabled = true; btn.textContent = 'â³';
  doScan(raw.toUpperCase(), raw.toUpperCase(), curTF).finally(() => { btn.disabled=false; btn.textContent='â–¶ Scan'; });
}

function setTF(tf, btn) {
  document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active'); curTF = tf;
  if (curYahoo) doScan(curYahoo, curLabel, tf);
  // Update WS subscription with new interval
  if (wsConn && wsConn.readyState === WebSocket.OPEN && curYahoo)
    wsConn.send(JSON.stringify({type:'subscribe', symbol: curYahoo, interval: tf}));
}

document.getElementById('sym-input').addEventListener('keydown', e => { if(e.key==='Enter') scanSymbol(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HERO SIGNAL CARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WHY = {
  pro_mtf:(s)=>s.type==='BUY'
    ?`<span class="ck">âœ“</span> EMA 9 crossed above EMA 21<br><span class="ck">âœ“</span> RSI ${s.rsi} > 50 â€” bullish<br><span class="ck">âœ“</span> Price above EMA 200<br><span class="ck">âœ“</span> Supertrend bullish`
    :`<span class="ck">âœ“</span> EMA 9 crossed below EMA 21<br><span class="ck">âœ“</span> RSI ${s.rsi} < 50 â€” bearish<br><span class="ck">âœ“</span> Price below EMA 200<br><span class="ck">âœ“</span> Supertrend bearish`,
  vwap_ema:(s)=>s.type==='BUY'
    ?`<span class="ck">âœ“</span> Price crossed above VWAP<br><span class="ck">âœ“</span> EMA 9 > EMA 21<br><span class="ck">âœ“</span> RSI ${s.rsi} > 50`
    :`<span class="ck">âœ“</span> Price crossed below VWAP<br><span class="ck">âœ“</span> EMA 9 < EMA 21<br><span class="ck">âœ“</span> RSI ${s.rsi} < 50`,
  rsi_reversal:(s)=>s.type==='BUY'
    ?`<span class="ck">âœ“</span> RSI ${s.rsi} crossed above 30 â€” oversold exit<br><span class="ck">âœ“</span> Price above EMA 50`
    :`<span class="ck">âœ“</span> RSI ${s.rsi} crossed below 70 â€” overbought exit<br><span class="ck">âœ“</span> Price below EMA 50`,
  bollinger:(s)=>s.type==='BUY'
    ?`<span class="ck">âœ“</span> Price broke above upper Bollinger Band<br><span class="ck">âœ“</span> RSI ${s.rsi} > 55<br><span class="ck">âœ“</span> Volume confirmed`
    :`<span class="ck">âœ“</span> Price broke below lower Bollinger Band<br><span class="ck">âœ“</span> RSI ${s.rsi} < 45<br><span class="ck">âœ“</span> Volume confirmed`,
  macd:(s)=>s.type==='BUY'
    ?`<span class="ck">âœ“</span> MACD crossed above Signal<br><span class="ck">âœ“</span> Histogram positive<br><span class="ck">âœ“</span> RSI ${s.rsi} > 50`
    :`<span class="ck">âœ“</span> MACD crossed below Signal<br><span class="ck">âœ“</span> Histogram negative<br><span class="ck">âœ“</span> RSI ${s.rsi} < 50`,
  supertrend_scalper:(s)=>s.type==='BUY'
    ?`<span class="ck">âœ“</span> Fast Supertrend(2,7) flipped bullish<br><span class="ck">âœ“</span> RSI ${s.rsi} > 45`
    :`<span class="ck">âœ“</span> Fast Supertrend(2,7) flipped bearish<br><span class="ck">âœ“</span> RSI ${s.rsi} < 55`,
};

function showHero(sig) {
  document.getElementById('no-signal').style.display = 'none';
  const el = document.getElementById('hero-inner');
  el.style.display = 'block'; el.className = sig.type;
  const whyFn = WHY[curStrategy] || WHY['pro_mtf'];
  const ttCard = sig.target_time ? `
    <div class="hc target-card">
      <div class="lbl">â± Target Time Estimate</div>
      <div class="val">${sig.target_time}</div>
      <div class="val-sub">By ${sig.target_datetime} Â· ~${sig.target_bars} bars</div>
    </div>` : '';
  el.innerHTML = `
    <div class="hero-type ${sig.type}">${sig.type==='BUY'?'â–² BUY SIGNAL':'â–¼ SELL SIGNAL'}</div>
    <div class="hero-grid">
      <div class="hc"><div class="lbl">Entry</div><div class="val" style="color:var(--yellow)">${fmt(sig.price)}</div></div>
      <div class="hc"><div class="lbl">Stop Loss</div><div class="val" style="color:var(--red)">${fmt(sig.sl)}</div></div>
      <div class="hc"><div class="lbl">Target</div><div class="val" style="color:var(--green)">${fmt(sig.tp)}</div></div>
      <div class="hc"><div class="lbl">RSI</div><div class="val">${sig.rsi}</div></div>
      <div class="hc"><div class="lbl">ATR</div><div class="val">${fmt(sig.atr)}</div></div>
      <div class="hc"><div class="lbl">R : R</div><div class="val">1 : 2</div></div>
      ${ttCard}
    </div>
    <div class="hero-why">${whyFn(sig)}</div>`;
  document.getElementById('entry-inp').value = sig.price;
  document.getElementById('sl-inp').value    = sig.sl;
  addSigHistory(sig);
  if (Notification.permission==='granted')
    new Notification(`${sig.type} â€” ${sig.symbol||curLabel}`, {body:`Entry:${sig.price}  SL:${sig.sl}  TP:${sig.tp}`});

}

function addSigHistory(sig) {
  sigHistory.unshift({...sig, ts:new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})});
  if (sigHistory.length > 60) sigHistory.pop();
  document.getElementById('sig-hist').innerHTML = sigHistory.map(s => `
    <div class="sig-card ${s.type}">
      <div class="sig-row"><b>${s.symbol||curLabel}</b><b style="color:${s.type==='BUY'?'var(--green)':'var(--red)'}">${s.type==='BUY'?'â–²':'â–¼'} ${s.type}</b></div>
      <div class="sig-row"><span>Entry</span><span class="v" style="color:var(--yellow)">${fmt(s.price)}</span></div>
      <div class="sig-row"><span>SL / TP</span><span class="v">${fmt(s.sl)} / <span style="color:var(--green)">${fmt(s.tp)}</span></span></div>
      ${s.target_time?`<div class="sig-row"><span>â± Target</span><span class="v" style="color:var(--yellow)">${s.target_time}</span></div>`:''}
      <div style="font-size:9px;color:var(--dim);text-align:right;margin-top:2px">${s.ts}</div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NEWS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadNews() {
  document.getElementById('news-loading').style.display = 'block';
  document.getElementById('news-list').innerHTML = '';
  document.getElementById('news-ts').textContent = 'Fetchingâ€¦';
  try {
    const syms = watchlist.map(w=>w.sym).join(',');
    const data = await (await fetch(`/api/news?symbols=${encodeURIComponent(syms)}`)).json();
    newsCache = data.news || [];
    renderNews(newsCache);
    document.getElementById('news-ts').textContent = `${newsCache.length} articles Â· ${new Date().toLocaleTimeString()}`;
  } catch(e) {
    document.getElementById('news-list').innerHTML = `<div style="color:var(--red);font-size:11px;padding:10px">Error: ${e.message}</div>`;
  } finally {
    document.getElementById('news-loading').style.display = 'none';
  }
}

function renderNews(news) {
  if (!news?.length) {
    document.getElementById('news-list').innerHTML = '<div style="text-align:center;color:var(--subtext);font-size:11px;padding:20px">No news available.<br>Check your internet connection.</div>';
    return;
  }
  document.getElementById('news-list').innerHTML = news.map(n => `
    <a class="news-card ${n.sentiment}" href="${n.url}" target="_blank" rel="noopener">
      <div class="news-top">
        <span class="news-cat">${n.icon} ${n.category}</span>
        <span class="news-age">${n.age}</span>
      </div>
      <div class="news-title">${n.title}</div>
      <div class="news-bottom">
        <span class="news-src">${n.source}</span>
        <div style="display:flex;gap:4px;align-items:center">
          <span class="news-sym">${n.symbol}</span>
          <span class="news-sent ${n.sentiment}">${n.sentiment==='positive'?'â–² Bullish':n.sentiment==='negative'?'â–¼ Bearish':'â— Neutral'}</span>
        </div>
      </div>
    </a>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PREDICTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadPrediction() {
  if (!curYahoo) return;
  document.getElementById('pred-sym-lbl').textContent = curLabel;
  document.getElementById('pred-loading').style.display = 'block';
  document.getElementById('pred-content').style.display = 'none';
  try {
    const data = await (await fetch(`/api/predict?symbol=${encodeURIComponent(curYahoo)}&interval=${curTF}`)).json();
    if (data.error) throw new Error(data.error);
    predCache[curYahoo] = data;
    renderPrediction(data);
  } catch(e) {
    document.getElementById('pred-content').innerHTML = `<div style="color:var(--red);font-size:11px;padding:10px">Error: ${e.message}</div>`;
    document.getElementById('pred-content').style.display = 'block';
  } finally {
    document.getElementById('pred-loading').style.display = 'none';
  }
}

function renderPrediction(p) {
  const el    = document.getElementById('pred-content');
  const isUp  = p.direction === 'BULLISH';
  const isNeu = p.direction === 'NEUTRAL';
  const dirColor = isUp ? 'var(--green)' : isNeu ? 'var(--yellow)' : 'var(--red)';
  const barColor = isUp ? 'var(--green)' : isNeu ? 'var(--yellow)' : 'var(--red)';
  const barWidth = isUp ? p.confidence : isNeu ? 50 : (100 - p.confidence);

  const bullHTML = p.bull_reasons?.map(r=>`<div class="pr-item bull">â–² ${r}</div>`).join('') || '';
  const bearHTML = p.bear_reasons?.map(r=>`<div class="pr-item bear">â–¼ ${r}</div>`).join('') || '';

  el.innerHTML = `
    <div class="pred-header">
      <div class="pred-dir ${p.direction}">${p.direction==='BULLISH'?'â–²':'â–¼'} ${p.direction}</div>
      <div class="pred-conf-bar-wrap"><div class="pred-conf-bar" style="width:${p.confidence}%;background:${barColor}"></div></div>
      <div class="pred-conf-lbl">Overall Confidence: <b style="color:${dirColor}">${p.confidence}%</b></div>
    </div>

    <div class="score-row">
      <div class="score-box">
        <div class="s-lbl">Tech Score</div>
        <div class="s-val" style="color:${p.tech_score>55?'var(--green)':p.tech_score<45?'var(--red)':'var(--yellow)'}">${p.tech_score}</div>
      </div>
      <div class="score-box">
        <div class="s-lbl">News Score</div>
        <div class="s-val" style="color:${p.news_score>55?'var(--green)':p.news_score<45?'var(--red)':'var(--yellow)'}">${p.news_score}</div>
      </div>
      <div class="score-box">
        <div class="s-lbl">RSI</div>
        <div class="s-val" style="color:${p.rsi>60?'var(--green)':p.rsi<40?'var(--red)':'var(--yellow)'}">${p.rsi}</div>
      </div>
    </div>

    <div class="pred-targets">
      <div class="pt"><div class="pt-lbl">Target 1</div><div class="pt-val" style="color:${isUp?'var(--green)':'var(--red)'}">${fmt(p.tp1)}</div></div>
      <div class="pt"><div class="pt-lbl">Target 2</div><div class="pt-val" style="color:${isUp?'var(--green)':'var(--red)'}">${fmt(p.tp2)}</div></div>
      <div class="pt"><div class="pt-lbl">Stop Loss</div><div class="pt-val" style="color:var(--red)">${fmt(p.sl)}</div></div>
    </div>

    <div class="pred-reasons">
      <div class="pr-title">ğŸ“Š Technical Analysis</div>
      ${bullHTML}${bearHTML}
    </div>

    <div style="font-size:9px;color:var(--dim);text-align:center;padding:4px">
      âš ï¸ For educational purposes only. Not financial advice.
    </div>`;
  el.style.display = 'block';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WEBSOCKET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let reconnTimer;
function setStatus(live, txt) {
  document.getElementById('dot').className = 'status-dot'+(live?' live':'');
  document.getElementById('status-lbl').textContent = txt;
}
let wsConn = null;
function connectWS() {
  const ws = new WebSocket((location.protocol==='https:'?'wss://':'ws://')+location.host+'/ws');
  wsConn = ws;
  ws.onopen = () => { setStatus(true,'Connected'); document.getElementById('conn-banner').style.display='none'; clearTimeout(reconnTimer);
    // Subscribe to current symbol immediately
    if (curYahoo) ws.send(JSON.stringify({type:'subscribe', symbol: curYahoo, interval: curTF}));
  };
  ws.onmessage = e => {
    try {
      const d = JSON.parse(e.data);
      if (d.type === 'status') {
        const open = d.open_markets || [];
        const any  = d.any_open || open.length > 0;
        setStatus(any, any ? `Open: ${open.join(', ')}` : 'Markets closed Â· Crypto 24/7');
        renderMktBadges(open);
      } else if (d.type === 'tick') {
        updateTick(d);
      } else if (d.type === 'signal' && d.symbol) {
        showHero(d);
        wlSignals[d.symbol] = d.type;
        renderWL();
        if (Notification.permission==='granted')
          new Notification(`ğŸ”” ${d.type} â€” ${d.symbol}`, {body:`Entry: ${fmt(d.price)}  SL: ${fmt(d.sl)}  TP: ${fmt(d.tp)}`});
      } else if (d.type === 'exit') {
        showExitBanner(d);
        if (d.symbol === curYahoo) clearActiveTrade();
        wlSignals[d.symbol] = 'NONE'; renderWL();
        if (Notification.permission==='granted')
          new Notification('Trade Closed â€” '+d.symbol,
            {body: d.exit_reason+' PnL: '+(d.pnl>=0?'+':'')+d.pnl+' ('+d.pnl_pct+'%)'});
      }
    } catch(err) {}
  };
  ws.onclose   = () => { wsConn=null; setStatus(false,'Reconnectingâ€¦'); document.getElementById('conn-banner').style.display='block'; reconnTimer=setTimeout(connectWS,5000); };
  ws.onerror   = () => ws.close();
}
document.body.addEventListener('click', () => { if(Notification.permission==='default') Notification.requestPermission(); }, {once:true});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RISK CALCULATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcRisk() {
  const cap=parseFloat(document.getElementById('capital').value)||0;
  const rp =parseFloat(document.getElementById('riskPct').value)||1;
  const ent=parseFloat(document.getElementById('entry-inp').value)||0;
  const sl =parseFloat(document.getElementById('sl-inp').value)||0;
  if(!ent||!sl||ent===sl){alert('Enter valid Entry and Stop Loss');return;}
  const riskAmt=cap*(rp/100), perUnit=Math.abs(ent-sl);
  const qty=Math.max(1,Math.floor(riskAmt/perUnit));
  const el=document.getElementById('risk-res');
  el.style.display='block';
  el.innerHTML=`<div class="rr"><span>Qty</span><span class="rv">${qty} units</span></div>
    <div class="rr"><span>Risk Amount</span><span class="rv">â‚¹${riskAmt.toFixed(2)}</span></div>
    <div class="rr"><span>Total Value</span><span class="rv">â‚¹${(qty*ent).toFixed(2)}</span></div>
    <div class="rr"><span>Risk / Unit</span><span class="rv">â‚¹${perUnit.toFixed(2)}</span></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmt(p) {
  if (p==null) return 'â€”';
  const n = Number(p);
  return n >= 1000 ? n.toLocaleString('en-IN',{maximumFractionDigits:2}) : n.toFixed(2);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ACTIVE TRADE MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function setActiveTrade(trade) {
  activeTrade = trade;
  const panel = document.getElementById('trade-panel');
  panel.style.display = 'block';
  panel.className = trade.side;

  // Badge
  const badge = document.getElementById('trade-badge');
  badge.className = 'trade-badge ' + trade.side;
  badge.textContent = (trade.side === 'BUY' ? 'â–² LONG' : 'â–¼ SHORT') + ' ACTIVE';

  // Cells
  document.getElementById('td-entry').textContent  = fmt(trade.entry_price);
  document.getElementById('td-tp').textContent     = fmt(trade.target_price);
  document.getElementById('td-sl').textContent     = fmt(trade.stop_loss);
  document.getElementById('td-conf').textContent   = trade.confidence + '%';
  document.getElementById('td-strat').textContent  = trade.strategy || 'â€”';

  // Progress bar class
  document.getElementById('td-progress').className = 'progress-bar ' + trade.side;

  // Hide exit banner, hide no-signal
  document.getElementById('exit-banner').style.display = 'none';
  document.getElementById('no-signal').style.display   = 'none';

  // Start elapsed timer
  if (tradeTimer) clearInterval(tradeTimer);
  tradeTimer = setInterval(() => tickTradeTimer(), 1000);
  tickTradeTimer();
}

function tickTradeTimer() {
  if (!activeTrade) return;
  const entryMs  = new Date(activeTrade.entry_time).getTime();
  const elapsed  = Math.max(0, Math.round((Date.now() - entryMs) / 60000));
  const estMin   = activeTrade.expected_time_minutes;
  const progress = Math.min(100, (elapsed / estMin) * 100);

  document.getElementById('td-elapsed').textContent = elapsed + 'm';
  document.getElementById('td-est').textContent     = Math.round(estMin) + 'm';
  document.getElementById('td-progress').style.width = progress + '%';
  // Turn progress bar yellow when near expiry (>80%)
  if (progress > 80)
    document.getElementById('td-progress').style.background = 'var(--yellow)';

  // Update current price cell from last known price
  if (lastLivePrice)
    document.getElementById('td-cur').textContent = fmt(lastLivePrice);
}

function updateLivePnl(pnl, currentPrice) {
  if (!activeTrade) return;
  const el    = document.getElementById('trade-pnl-val');
  const sign  = pnl >= 0 ? '+' : '';
  el.textContent = sign + fmt(pnl);
  el.className   = 'profit' ? (pnl >= 0 ? 'profit' : 'loss') : 'loss';
  el.className   = pnl >= 0 ? 'profit' : 'loss';
  if (lastLivePrice)
    document.getElementById('td-cur').textContent = fmt(currentPrice);
}

function clearActiveTrade() {
  activeTrade = null;
  if (tradeTimer) { clearInterval(tradeTimer); tradeTimer = null; }
  document.getElementById('trade-panel').style.display = 'none';
}

function showExitBanner(ev) {
  const isProfit = ev.pnl >= 0;
  const banner   = document.getElementById('exit-banner');
  banner.style.display = 'block';
  banner.className     = isProfit ? 'profit' : 'loss';

  const title = document.getElementById('exit-title');
  title.className   = 'exit-title ' + (isProfit ? 'profit' : 'loss');
  title.textContent = isProfit ? 'âœ… Trade Profitable!' : 'âŒ Trade Closed at Loss';

  // Reason badge
  const rb    = document.getElementById('exit-reason-badge');
  const rmap  = {'Target Hit':'target','Stop Hit':'stop','Time Exit':'time',
                 'EOD Exit':'eod','Manual Close':'manual'};
  rb.className   = 'exit-reason-badge ' + (rmap[ev.exit_reason] || 'manual');
  rb.textContent = ev.exit_reason;

  // Cells
  document.getElementById('ex-entry').textContent = fmt(ev.entry_price);
  document.getElementById('ex-exit').textContent  = fmt(ev.exit_price);
  const sign = ev.pnl >= 0 ? '+' : '';
  const pnlEl = document.getElementById('ex-pnl');
  pnlEl.textContent  = sign + fmt(ev.pnl) + ' (' + sign + ev.pnl_pct + '%)';
  pnlEl.style.color  = ev.pnl >= 0 ? 'var(--green)' : 'var(--red)';
  document.getElementById('ex-dur').textContent   = Math.round(ev.duration_minutes) + 'm';

  // Hide trade panel, hide no-signal
  document.getElementById('trade-panel').style.display  = 'none';
  document.getElementById('no-signal').style.display    = 'none';

  addExitToHistory(ev);
}

function dismissExit() {
  document.getElementById('exit-banner').style.display = 'none';
  // Show no-signal hint if no hero and no active trade
  if (!activeTrade) {
    const hero = document.getElementById('hero-inner');
    if (hero.style.display === 'none' || !hero.style.display)
      document.getElementById('no-signal').style.display = 'block';
  }
}

function addExitToHistory(ev) {
  const pnlSign = ev.pnl >= 0 ? '+' : '';
  const card = document.createElement('div');
  card.className = 'sig-card ' + ev.side;
  card.innerHTML =
    '<div class="sig-row"><b>' + ev.symbol + '</b><b style="color:' +
    (ev.pnl >= 0 ? 'var(--green)' : 'var(--red)') + '">' +
    ev.exit_reason + '</b></div>' +
    '<div class="sig-row"><span>PnL</span><span class="v" style="color:' +
    (ev.pnl >= 0 ? 'var(--green)' : 'var(--red') + '">' +
    pnlSign + fmt(ev.pnl) + ' (' + pnlSign + ev.pnl_pct + '%)</span></div>' +
    '<div class="sig-row"><span>Entryâ†’Exit</span><span class="v">' +
    fmt(ev.entry_price) + ' â†’ ' + fmt(ev.exit_price) + '</span></div>' +
    '<div style="font-size:9px;color:var(--dim);text-align:right;margin-top:2px">' +
    Math.round(ev.duration_minutes) + 'm Â· ' + new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'}) +
    '</div>';
  const hist = document.getElementById('sig-hist');
  hist.insertBefore(card, hist.firstChild);
}

async function manualCloseTrade() {
  if (!activeTrade || !curYahoo) return;
  const btn = document.getElementById('trade-close-btn');
  btn.textContent = 'â³ Closingâ€¦'; btn.disabled = true;
  try {
    const price = lastLivePrice || 0;
    const res = await fetch('/api/trade/' + encodeURIComponent(curYahoo) + '?price=' + price,
                            {method:'DELETE'});
    const data = await res.json();
    if (data.exit) {
      showExitBanner(data.exit);
      clearActiveTrade();
    }
  } catch(e) {
    console.error('Close trade error:', e);
  } finally {
    btn.textContent = 'âœ• Close Trade Now'; btn.disabled = false;
  }
}

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>
</body>
</html>