<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pro Trading Terminal</title>

<script src="https://s3.tradingview.com/tv.js"></script>

<style>
body {
    margin:0;
    background:#0b1220;
    color:white;
    font-family:Arial;
}

.grid {
    display:grid;
    grid-template-columns:3fr 1fr;
    grid-template-rows:70vh 30vh;
    gap:5px;
    height:100vh;
}

.panel {
    background:#111827;
    border-radius:6px;
    padding:10px;
    overflow:auto;
}

#chart { grid-column:1; grid-row:1 / span 2; }
#signals { grid-column:2; grid-row:1; }
#risk { grid-column:2; grid-row:2; }
button { padding:5px 10px; margin-top:5px; }
</style>
</head>

<body>

<div class="grid">
    <div id="chart" class="panel"></div>

    <div id="signals" class="panel">
        <h3>Live Signals</h3>
        <div id="signalBox">Waiting...</div>
    </div>

    <div id="risk" class="panel">
        <h3>Risk Calculator</h3>

        Capital: <input id="capital" type="number" value="100000"><br>
        Risk %: <input id="riskPercent" type="number" value="1"><br>
        Entry: <input id="entry" type="number"><br>
        Stoploss: <input id="sl" type="number"><br>

        <button onclick="calculateRisk()">Calculate</button>

        <div id="riskResult"></div>
    </div>
</div>

<script>
new TradingView.widget({
    container_id: "chart",
    width: "100%",
    height: "100%",
    symbol: "NSE:NIFTY",
    interval: "5",
    timezone: "Asia/Kolkata",
    theme: "dark"
});

/* WebSocket */
const protocol = location.protocol === "https:" ? "wss://" : "ws://";
const socket = new WebSocket(protocol + location.host + "/ws");

socket.onmessage = function(event) {
    const data = JSON.parse(event.data);

    if(data.symbol){
        document.getElementById("signalBox").innerHTML =
            `<b>${data.symbol}</b><br>
             Signal: ${data.signal}<br>
             Price: ${data.price}<br>
             AI Probability: ${data.probability}%`;
    }
};

/* Risk Calculator */
async function calculateRisk(){
    const capital = document.getElementById("capital").value;
    const riskPercent = document.getElementById("riskPercent").value;
    const entry = document.getElementById("entry").value;
    const sl = document.getElementById("sl").value;

    const res = await fetch(`/risk?capital=${capital}&risk_percent=${riskPercent}&entry=${entry}&stoploss=${sl}`);
    const data = await res.json();

    document.getElementById("riskResult").innerText =
        "Suggested Quantity: " + data.quantity;
}
</script>

</body>
</html>
